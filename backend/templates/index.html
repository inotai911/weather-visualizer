<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°—è±¡æƒ…å ±å¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-size: 12px;
            color: #666;
            font-weight: bold;
        }
        
        select, input, button {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        .map-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .weather-icon {
            font-size: 24px;
        }
        
        .status-message {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            background: #e0e0e0;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ¤ï¸ æ°—è±¡æƒ…å ±å¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ </h1>
        
        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="card">
            <h2>ğŸ“ ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>
            <div id="statusMessage" class="status-message"></div>
            <div class="controls">
                <div class="control-group">
                    <label>åœ°åŸŸåï¼ˆéƒ½å¸‚åã‚’å…¥åŠ›ï¼‰</label>
                    <input type="text" id="locationInput" placeholder="ä¾‹: Tokyo, New York, London" list="locationSuggestions">
                    <datalist id="locationSuggestions"></datalist>
                </div>
                <div class="control-group">
                    <label>é–‹å§‹æ—¥</label>
                    <input type="date" id="startDate">
                </div>
                <div class="control-group">
                    <label>çµ‚äº†æ—¥</label>
                    <input type="date" id="endDate">
                </div>

                <button onclick="fetchWeatherData()" class="btn-success">ğŸ”„ APIå–å¾—</button>
            </div>
        </div>
        
        <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
        <div class="card" id="statsCard" style="display: none;">
            <h2>ğŸ“ˆ çµ±è¨ˆã‚µãƒãƒªãƒ¼</h2>
            <div class="stats-grid" id="statsGrid">
            </div>
        </div>
        
        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('chart')">ğŸ“Š ã‚°ãƒ©ãƒ•</button>
            <button class="tab" onclick="showTab('table')">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿è¡¨</button>
            <button class="tab" onclick="showTab('logs')">ğŸ“ æ“ä½œãƒ­ã‚°</button>
        </div>
        
        <!-- ã‚°ãƒ©ãƒ•ã‚¿ãƒ– -->
        <div id="chartTab" class="tab-content active">
            <div class="card">
                <h2>ğŸ“Š æ°—è±¡ã‚°ãƒ©ãƒ•</h2>
                <div class="controls">
                    <div class="control-group">
                        <label>ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥</label>
                        <select id="chartTypeSelect" onchange="updateChart()">
                            <option value="temperature">ğŸŒ¡ï¸ æ°—æ¸©</option>
                            <option value="humidity">ğŸ’§ æ¹¿åº¦</option>
                            <option value="precipitation">ğŸŒ§ï¸ é™æ°´é‡</option>
                            <option value="wind">ğŸ’¨ é¢¨é€Ÿ</option>
                            <option value="pressure">ğŸ”˜ æ°—åœ§</option>
                        </select>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="chart-container">
                        <canvas id="mainChart"></canvas>
                    </div>
                    <div class="map-container" id="mapContainer">
                        <div id="locationMap" style="width: 100%; height: 100%; border-radius: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿è¡¨ã‚¿ãƒ– -->
        <div id="tableTab" class="tab-content">
            <div class="card">
                <h2>ğŸ“‹ æ°—è±¡ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</h2>
                <div class="table-container">
                    <table id="weatherTable">
                        <thead>
                            <tr>
                                <th>æ—¥æ™‚</th>
                                <th>åœ°åŸŸ</th>
                                <th>å¤©æ°—</th>
                                <th>æ°—æ¸©(â„ƒ)</th>
                                <th>æ¹¿åº¦(%)</th>
                                <th>é™æ°´é‡(mm)</th>
                                <th>é¢¨é€Ÿ(m/s)</th>
                                <th>æ°—åœ§(hPa)</th>
                            </tr>
                        </thead>
                        <tbody id="weatherTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ãƒ­ã‚°ã‚¿ãƒ– -->
        <div id="logsTab" class="tab-content">
            <div class="card">
                <h2>ğŸ“ æ“ä½œãƒ­ã‚°</h2>
                <div class="table-container">
                    <table id="logsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>æ“ä½œç¨®åˆ¥</th>
                                <th>è©³ç´°</th>
                                <th>æ—¥æ™‚</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let mainChart = null;
        let comparisonChart = null;
        let currentWeatherData = [];
        
        // å¤©æ°—ã‚³ãƒ¼ãƒ‰ã‹ã‚‰çµµæ–‡å­—ã«å¤‰æ›
        function getWeatherEmoji(code) {
            if (code === null || code === undefined) return 'â“';
            if (code === 0) return 'â˜€ï¸';
            if (code <= 3) return 'â›…';
            if (code <= 49) return 'ğŸŒ«ï¸';
            if (code <= 59) return 'ğŸŒ§ï¸';
            if (code <= 69) return 'ğŸŒ¨ï¸';
            if (code <= 79) return 'â„ï¸';
            if (code <= 84) return 'ğŸŒ§ï¸';
            if (code <= 94) return 'â›ˆï¸';
            return 'ğŸŒªï¸';
        }
        
        // åˆæœŸåŒ–
        async function init() {
            initMap();
            await loadLocations();
            setDefaultDates();
            await loadData();
        }
        
        // åœ°åŸŸä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚µã‚¸ã‚§ã‚¹ãƒˆç”¨ï¼‰
        async function loadLocations() {
            try {
                const response = await fetch(`${API_BASE}/api/locations`);
                const locations = await response.json();
                const datalist = document.getElementById('locationSuggestions');
                datalist.innerHTML = '';
                locations.forEach(loc => {
                    datalist.innerHTML += `<option value="${loc.name}">`;
                });
            } catch (error) {
                console.error('åœ°åŸŸèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜ã‚’è¨­å®š
        function setDefaultDates() {
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
        }
        
        // åœ°å›³ã®åˆæœŸåŒ–
        let map = null;
        let currentMarker = null;
        
        function initMap() {
            // ä¸–ç•Œåœ°å›³ã‚’åˆæœŸè¡¨ç¤º
            map = L.map('locationMap').setView([35, 135], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
        }
        
        // åœ°å›³ã‚’æ›´æ–°
        function updateMap(location) {
            if (!map) {
                initMap();
            }
            
            if (!location) {
                // åœ°åŸŸæœªæŒ‡å®šã®å ´åˆã¯ä¸–ç•Œå…¨ä½“ã‚’è¡¨ç¤º
                map.setView([35, 135], 2);
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                    currentMarker = null;
                }
                return;
            }
            
            // Nominatim APIã§åº§æ¨™ã‚’å–å¾—ã—ã¦åœ°å›³ã‚’ç§»å‹•
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1`)
                .then(res => res.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        
                        // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
                        if (currentMarker) {
                            map.removeLayer(currentMarker);
                        }
                        
                        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§æŒ‡å®šä½ç½®ã«ç§»å‹•
                        map.flyTo([lat, lon], 10, {
                            duration: 2
                        });
                        
                        // ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
                        currentMarker = L.marker([lat, lon]).addTo(map)
                            .bindPopup(`<b>${location}</b><br>ç·¯åº¦: ${lat.toFixed(4)}<br>çµŒåº¦: ${lon.toFixed(4)}`)
                            .openPopup();
                    }
                })
                .catch(err => console.error('åœ°å›³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err));
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        function showStatus(message, isError = false) {
            const elem = document.getElementById('statusMessage');
            elem.textContent = message;
            elem.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
            setTimeout(() => {
                elem.className = 'status-message';
            }, 5000);
        }
        
        // æ°—è±¡ãƒ‡ãƒ¼ã‚¿ã‚’APIã‹ã‚‰å–å¾—
        async function fetchWeatherData() {
            const location = document.getElementById('locationInput').value.trim();
            if (!location) {
                showStatus('åœ°åŸŸåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/weather/fetch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ location_name: location, days: 7 })
                });
                
                const result = await response.json();
                if (response.ok) {
                    showStatus(`${location}ã®æ°—è±¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`);
                    updateMap(location);
                    await loadData();
                } else {
                    showStatus(result.error, true);
                }
            } catch (error) {
                showStatus('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            }
        }
        
        // å…¨åœ°åŸŸã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        async function fetchAllWeatherData() {
            try {
                showStatus('å…¨åœ°åŸŸã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
                const response = await fetch(`${API_BASE}/api/weather/fetch_all`, {
                    method: 'POST'
                });
                const result = await response.json();
                const successCount = result.results.filter(r => r.success).length;
                showStatus(`${successCount}/${result.results.length} åœ°åŸŸã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`);
                loadData();
            } catch (error) {
                showStatus('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadData() {
            const location = document.getElementById('locationInput').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let url = `${API_BASE}/api/weather?limit=168`;
            if (location) url += `&location=${encodeURIComponent(location)}`;
            if (startDate) url += `&start_date=${startDate}`;
            if (endDate) url += `&end_date=${endDate}T23:59:59`;
            
            try {
                const response = await fetch(url);
                currentWeatherData = await response.json();
                updateTable();
                updateChart();
                updateStats();
                loadLogs();
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // çµ±è¨ˆã‚’æ›´æ–°
        function updateStats() {
            if (currentWeatherData.length === 0) {
                document.getElementById('statsCard').style.display = 'none';
                return;
            }
            
            document.getElementById('statsCard').style.display = 'block';
            
            const temps = currentWeatherData.filter(d => d.temperature !== null).map(d => d.temperature);
            const humidity = currentWeatherData.filter(d => d.humidity !== null).map(d => d.humidity);
            const precip = currentWeatherData.filter(d => d.precipitation !== null).map(d => d.precipitation);
            const wind = currentWeatherData.filter(d => d.wind_speed !== null).map(d => d.wind_speed);
            
            const stats = [
                { label: 'å¹³å‡æ°—æ¸©', value: temps.length ? (temps.reduce((a,b) => a+b, 0) / temps.length).toFixed(1) + 'â„ƒ' : '-' },
                { label: 'æœ€é«˜æ°—æ¸©', value: temps.length ? Math.max(...temps).toFixed(1) + 'â„ƒ' : '-' },
                { label: 'æœ€ä½æ°—æ¸©', value: temps.length ? Math.min(...temps).toFixed(1) + 'â„ƒ' : '-' },
                { label: 'å¹³å‡æ¹¿åº¦', value: humidity.length ? (humidity.reduce((a,b) => a+b, 0) / humidity.length).toFixed(0) + '%' : '-' },
                { label: 'ç·é™æ°´é‡', value: precip.length ? precip.reduce((a,b) => a+b, 0).toFixed(1) + 'mm' : '-' },
                { label: 'å¹³å‡é¢¨é€Ÿ', value: wind.length ? (wind.reduce((a,b) => a+b, 0) / wind.length).toFixed(1) + 'm/s' : '-' },
            ];
            
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = stats.map(s => `
                <div class="stat-card">
                    <div class="stat-value">${s.value}</div>
                    <div class="stat-label">${s.label}</div>
                </div>
            `).join('');
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
        function updateTable() {
            const tbody = document.getElementById('weatherTableBody');
            tbody.innerHTML = currentWeatherData.map(d => `
                <tr>
                    <td>${new Date(d.timestamp).toLocaleString('ja-JP')}</td>
                    <td>${d.location_name}</td>
                    <td class="weather-icon">${getWeatherEmoji(d.weather_code)}</td>
                    <td>${d.temperature !== null ? d.temperature.toFixed(1) : '-'}</td>
                    <td>${d.humidity !== null ? d.humidity.toFixed(0) : '-'}</td>
                    <td>${d.precipitation !== null ? d.precipitation.toFixed(1) : '-'}</td>
                    <td>${d.wind_speed !== null ? d.wind_speed.toFixed(1) : '-'}</td>
                    <td>${d.pressure !== null ? d.pressure.toFixed(0) : '-'}</td>
                </tr>
            `).join('');
        }
        
        // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
        function updateChart() {
            const chartType = document.getElementById('chartTypeSelect').value;
            const location = document.getElementById('locationInput').value.trim();
            
            const labels = {
                temperature: { label: 'æ°—æ¸© (â„ƒ)', color: '#ff6384' },
                humidity: { label: 'æ¹¿åº¦ (%)', color: '#36a2eb' },
                precipitation: { label: 'é™æ°´é‡ (mm)', color: '#4bc0c0' },
                wind: { label: 'é¢¨é€Ÿ (m/s)', color: '#ff9f40' },
                pressure: { label: 'æ°—åœ§ (hPa)', color: '#9966ff' }
            };
            
            const dataKey = chartType === 'wind' ? 'wind_speed' : chartType;
            const sortedData = [...currentWeatherData].sort((a, b) => 
                new Date(a.timestamp) - new Date(b.timestamp)
            );
            
            // ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒ¼ãƒˆ
            const chartData = sortedData.filter(d => d[dataKey] !== null);
            
            if (mainChart) mainChart.destroy();
            
            const ctx = document.getElementById('mainChart').getContext('2d');
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => new Date(d.timestamp).toLocaleString('ja-JP', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    })),
                    datasets: [{
                        label: labels[chartType].label,
                        data: chartData.map(d => d[dataKey]),
                        borderColor: labels[chartType].color,
                        backgroundColor: labels[chartType].color + '40',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${location || 'å…¨åœ°åŸŸ'} - ${labels[chartType].label}ã®æ¨ç§»`
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'æ—¥æ™‚' }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: labels[chartType].label }
                        }
                    }
                }
            });
            
            // æ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆï¼ˆåœ°åŸŸåˆ¥ã¾ãŸã¯æ—¥åˆ¥å¹³å‡ï¼‰
            updateComparisonChart(chartType, dataKey);
        }
        
        // æ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
        function updateComparisonChart(chartType, dataKey) {
            const labels = {
                temperature: { label: 'æ°—æ¸© (â„ƒ)', color: '#ff6384' },
                humidity: { label: 'æ¹¿åº¦ (%)', color: '#36a2eb' },
                precipitation: { label: 'é™æ°´é‡ (mm)', color: '#4bc0c0' },
                wind: { label: 'é¢¨é€Ÿ (m/s)', color: '#ff9f40' },
                pressure: { label: 'æ°—åœ§ (hPa)', color: '#9966ff' }
            };
            
            // åœ°åŸŸåˆ¥ã®å¹³å‡å€¤ã‚’è¨ˆç®—
            const locationData = {};
            currentWeatherData.forEach(d => {
                if (d[dataKey] !== null) {
                    if (!locationData[d.location_name]) {
                        locationData[d.location_name] = [];
                    }
                    locationData[d.location_name].push(d[dataKey]);
                }
            });
            
            const locationNames = Object.keys(locationData);
            const averages = locationNames.map(name => {
                const values = locationData[name];
                return values.reduce((a, b) => a + b, 0) / values.length;
            });
            
            if (comparisonChart) comparisonChart.destroy();
            
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: locationNames,
                    datasets: [{
                        label: `å¹³å‡${labels[chartType].label}`,
                        data: averages,
                        backgroundColor: locationNames.map((_, i) => 
                            `hsl(${i * 45}, 70%, 60%)`
                        ),
                        borderColor: locationNames.map((_, i) => 
                            `hsl(${i * 45}, 70%, 40%)`
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `åœ°åŸŸåˆ¥ å¹³å‡${labels[chartType].label}`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: chartType === 'precipitation'
                        }
                    }
                }
            });
        }
        
        // ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
        async function loadLogs() {
            try {
                const response = await fetch(`${API_BASE}/api/logs?limit=50`);
                const logs = await response.json();
                
                const tbody = document.getElementById('logsTableBody');
                tbody.innerHTML = logs.map(log => `
                    <tr>
                        <td>${log.id}</td>
                        <td>${log.action_type}</td>
                        <td>${log.action_detail || '-'}</td>
                        <td>${new Date(log.timestamp).toLocaleString('ja-JP')}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('ãƒ­ã‚°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
            
            if (tabName === 'logs') {
                loadLogs();
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
